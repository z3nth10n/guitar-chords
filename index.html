<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detector de acordes para guitarra</title>
  <style>
    :root {
      --bg: #020617;
      --bg-alt: #0f172a;
      --card-bg: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.25);
      --border: #1f2933;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --error: #fb7185;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at top left, #1d4ed8 0, transparent 55%),
        radial-gradient(circle at bottom right, #22c55e 0, transparent 55%),
        var(--bg);
    }

    .app {
      width: 100%;
      max-width: 680px;
      background: linear-gradient(to bottom right, rgba(15,23,42,0.96), rgba(15,23,42,0.98));
      border-radius: 24px;
      padding: 22px 26px 20px;
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(148, 163, 184, 0.1);
    }

    h1 {
      margin: 0 0 4px;
      font-size: 22px;
      letter-spacing: 0.03em;
    }

    .subtitle {
      margin: 0 0 16px;
      font-size: 13px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .controls label {
      font-size: 13px;
      color: var(--muted);
    }

    select {
      background: #020617;
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 13px;
      outline: none;
      min-width: 180px;
    }

    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .strings-container {
      border-radius: 18px;
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.18), transparent 55%),
                  rgba(15, 23, 42, 0.9);
      padding: 10px 14px;
      margin-bottom: 12px;
    }

    .strings-header {
      display: grid;
      grid-template-columns: 70px 1fr 1fr 90px;
      gap: 8px;
      padding-bottom: 4px;
      margin-bottom: 4px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .string-row {
      display: grid;
      grid-template-columns: 70px 1fr 1fr 90px;
      align-items: center;
      gap: 8px;
      padding: 2px 0;
    }

    .string-label {
      font-size: 12px;
      color: var(--muted);
    }

    input {
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 13px;
      color: var(--text);
      outline: none;
      width: 100%;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    input.string-tuning {
      text-align: center;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.85);
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.7);
    }

    .string-tuning-editable {
      border-style: solid;
      border-color: var(--accent);
      background: rgba(34, 197, 94, 0.08);
    }

    input.fret-input {
      text-align: center;
    }

    input.string-note {
      text-align: center;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    input.fret-input::placeholder {
      color: rgba(148, 163, 184, 0.7);
    }

    #calcButton {
      margin-top: 8px;
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #a3e635);
      color: #022c22;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    #calcButton:hover {
      filter: brightness(1.05);
      transform: translateY(-0.5px);
    }

    #calcButton:active {
      transform: translateY(0.5px);
      filter: brightness(0.97);
    }

    #messages {
      margin-top: 10px;
      min-height: 54px;
    }

    #errors {
      min-height: 18px;
      font-size: 12px;
      color: var(--error);
    }

    #result {
      margin-top: 4px;
      font-size: 20px;
      font-weight: 700;
    }

    #detail {
      margin-top: 2px;
      font-size: 13px;
      color: var(--muted);
    }

    .hint {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    #saveChordButton {
      margin-top: 6px;
      width: 100%;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: transparent;
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }

    #saveChordButton:hover {
      background: rgba(148, 163, 184, 0.15);
    }

    #savedChords {
      margin-top: 12px;
      font-size: 12px;
    }

    .saved-chord {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
    }

    .saved-chord-title {
      font-weight: 600;
      font-size: 13px;
    }

    .saved-chord-notes,
    .saved-chord-frets,
    .saved-chord-info {
      color: var(--muted);
      margin-top: 1px;
    }

    @media (max-width: 600px) {
      .app {
        padding: 18px 16px 16px;
        border-radius: 20px;
      }

      .string-row,
      .strings-header {
        grid-template-columns: 60px 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Detector de acordes</h1>
    <p class="subtitle">Elige afinación, escribe los trastes y te digo qué acorde es.</p>

    <div class="controls">
      <label for="tuningSelect">Afinación:</label>
      <select id="tuningSelect"></select>

      <label for="notationSelect">Notación:</label>
      <select id="notationSelect">
        <option value="latin">Latina (Do, Re, Mi...)</option>
        <option value="anglo">Anglosajona (C, D, E...)</option>
      </select>
    </div>

    <div class="strings-container">
      <div class="strings-header">
        <div>Cuerda</div>
        <div>Afinación</div>
        <div>Traste</div>
        <div>Nota</div>
      </div>

      <!-- Cuerda 1 (más aguda) -->
      <div class="string-row" data-string="1">
        <div class="string-label">Cuerda 1</div>
        <input class="string-tuning" type="text" readonly />
        <input class="fret-input" type="text" placeholder="0, 1, 3, x..." />
        <input class="string-note" type="text" readonly />
      </div>

      <!-- Cuerda 2 -->
      <div class="string-row" data-string="2">
        <div class="string-label">Cuerda 2</div>
        <input class="string-tuning" type="text" readonly />
        <input class="fret-input" type="text" placeholder="0, 1, 3, x..." />
        <input class="string-note" type="text" readonly />
      </div>

      <!-- Cuerda 3 -->
      <div class="string-row" data-string="3">
        <div class="string-label">Cuerda 3</div>
        <input class="string-tuning" type="text" readonly />
        <input class="fret-input" type="text" placeholder="0, 1, 3, x..." />
        <input class="string-note" type="text" readonly />
      </div>

      <!-- Cuerda 4 -->
      <div class="string-row" data-string="4">
        <div class="string-label">Cuerda 4</div>
        <input class="string-tuning" type="text" readonly />
        <input class="fret-input" type="text" placeholder="0, 1, 3, x..." />
        <input class="string-note" type="text" readonly />
      </div>

      <!-- Cuerda 5 -->
      <div class="string-row" data-string="5">
        <div class="string-label">Cuerda 5</div>
        <input class="string-tuning" type="text" readonly />
        <input class="fret-input" type="text" placeholder="0, 1, 3, x..." />
        <input class="string-note" type="text" readonly />
      </div>

      <!-- Cuerda 6 (más grave) -->
      <div class="string-row" data-string="6">
        <div class="string-label">Cuerda 6</div>
        <input class="string-tuning" type="text" readonly />
        <input class="fret-input" type="text" placeholder="0, 1, 3, x..." />
        <input class="string-note" type="text" readonly />
      </div>
    </div>

    <button id="calcButton">Calcular acorde</button>
    <button id="saveChordButton" type="button">Guardar acorde</button>

    <div id="messages">
      <div id="errors"></div>
      <div id="result"></div>
      <div id="detail"></div>
    </div>

    <div id="savedChords"></div>

    <p class="hint">
      Deja una casilla vacía o escribe <strong>x</strong> si esa cuerda no suena.
      Usa números de <strong>0 a 24</strong> para los trastes.
    </p>
  </div>

  <script>
    // Nombres de notas (clases de tono)
    const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F",
      "F#", "G", "G#", "A", "A#", "B"];

    // Nombres de notas en notación latina (Do, Re, Mi...)
    const NOTE_NAMES_LATIN = ["Do", "Do#", "Re", "Re#", "Mi", "Fa",
      "Fa#", "Sol", "Sol#", "La", "La#", "Si"];

    // Estado actual de notación (anglosajona o latina)
    let currentNotation = "latin";

    function getNoteName(pc) {
      return currentNotation === "latin"
        ? NOTE_NAMES_LATIN[pc]
        : NOTE_NAMES[pc];
    }

    // Afinaciones: valores = clases de tono de la cuerda 1 a la 6 (aguda a grave)
    const TUNINGS = {
      "E estándar":       { notes: [4, 11, 7, 2, 9, 4] }, // E B G D A E
      "Drop D":           { notes: [4, 11, 7, 2, 9, 2] }, // E B G D A D
      "D estándar":       { notes: [2, 9, 5, 0, 7, 2] },  // D A F C G D
      "Drop C":           { notes: [2, 9, 5, 0, 7, 0] },  // D A F C G C
      "Drop B":           { notes: [1, 8, 4, 11, 6, 11] },// C# G# E B F# B
      "Drop A":           { notes: [11, 6, 2, 9, 4, 9] }, // B F# D A E A
      "Personalizada":    { notes: [4, 11, 7, 2, 9, 4] }  // empieza como E estándar
    };

    const customTuningName = "Personalizada";
    const savedChords = [];
    let lastChordData = null;

    // Patrones de acordes (intervalos relativos a la tónica)
    const CHORD_PATTERNS = [
      { name: "Mayor",               suffix: "",      intervals: [0, 4, 7] },
      { name: "Menor",               suffix: "m",     intervals: [0, 3, 7] },
      { name: "Disminuido",          suffix: "dim",   intervals: [0, 3, 6] },
      { name: "Aumentado",           suffix: "aug",   intervals: [0, 4, 8] },
      { name: "Suspendido 2",        suffix: "sus2",  intervals: [0, 2, 7] },
      { name: "Suspendido 4",        suffix: "sus4",  intervals: [0, 5, 7] },
      { name: "Mayor 7",             suffix: "maj7",  intervals: [0, 4, 7, 11] },
      { name: "Menor 7",             suffix: "m7",    intervals: [0, 3, 7, 10] },
      { name: "Dominante 7",         suffix: "7",     intervals: [0, 4, 7, 10] },
      { name: "Semidisminuido 7",    suffix: "m7b5",  intervals: [0, 3, 6, 10] },
      { name: "Disminuido 7",        suffix: "dim7",  intervals: [0, 3, 6, 9] },
      { name: "Menor mayor 7",       suffix: "mMaj7", intervals: [0, 3, 7, 11] },
      { name: "Mayor 6",             suffix: "6",     intervals: [0, 4, 7, 9] },
      { name: "Menor 6",             suffix: "m6",    intervals: [0, 3, 7, 9] }
    ];

    document.addEventListener("DOMContentLoaded", () => {
      const tuningSelect   = document.getElementById("tuningSelect");
      const notationSelect = document.getElementById("notationSelect");
      const fretInputs     = Array.from(document.querySelectorAll(".fret-input"));
      const tuningInputs   = Array.from(document.querySelectorAll(".string-tuning"));

      // Rellenar el dropdown de afinaciones (incluye "Personalizada")
      Object.keys(TUNINGS).forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        tuningSelect.appendChild(option);
      });

      // Valor inicial de notación
      currentNotation = notationSelect.value || "anglo";

      // Afinación por defecto
      tuningSelect.value = "E estándar";
      applyTuning("E estándar");
      enableCustomTuningEditing(false);

      // Cambio de afinación
      tuningSelect.addEventListener("change", (e) => {
        const value = e.target.value;
        const isCustom = value === customTuningName;
        enableCustomTuningEditing(isCustom);
        applyTuning(value);
        clearFretInputs();
        clearMessages();
        updateStringNotes();
      });

      // Cambio de notación (anglosajona / latina)
      notationSelect.addEventListener("change", (e) => {
        currentNotation = e.target.value;
        // Reescribir las afinaciones con la notación nueva
        applyTuning(tuningSelect.value);
        updateStringNotes(); // para que cambie también Do/Re <-> C/D en la tercera columna
      });

      // Editar afinación a mano cuando estamos en "Personalizada"
      tuningInputs.forEach((input, index) => {
        input.addEventListener("change", () => {
          if (tuningSelect.value !== customTuningName) return;

          const pc = parseNoteName(input.value);
          if (pc === null) {
            // Si está mal escrita, volvemos a la nota que había
            input.value = getNoteName(TUNINGS[customTuningName].notes[index]);
          } else {
            TUNINGS[customTuningName].notes[index] = pc;
            input.value = getNoteName(pc); // normaliza a la notación actual
          }
        });
      });

      document.getElementById("calcButton").addEventListener("click", calculateChord);
      document.getElementById("saveChordButton").addEventListener("click", saveChord);

      // Navegación con Enter y Tab entre casillas de traste
      fretInputs.forEach(input => {
        input.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter") {
            calculateChord();
          } else if (ev.key === "Tab") {
            ev.preventDefault();
            const idx = fretInputs.indexOf(ev.target);
            let nextIndex;
            if (ev.shiftKey) {
              nextIndex = (idx - 1 + fretInputs.length) % fretInputs.length;
            } else {
              nextIndex = (idx + 1) % fretInputs.length;
            }
            fretInputs[nextIndex].focus();
            fretInputs[nextIndex].select();
          }
        });
        input.addEventListener("input", () => {
          updateStringNotes();
        });
      });

      renderSavedChords();
    });

    function enableCustomTuningEditing(isCustom) {
      const tuningInputs = document.querySelectorAll(".string-tuning");
      tuningInputs.forEach(input => {
        input.readOnly = !isCustom;
        input.classList.toggle("string-tuning-editable", isCustom);
      });
    }

    function applyTuning(tuningName) {
      const tuning = TUNINGS[tuningName];
      const tuningInputs = document.querySelectorAll(".string-tuning");
      tuningInputs.forEach((input, index) => {
        const pc = tuning.notes[index];
        input.value = getNoteName(pc);
      });
    }

    function updateStringNotes() {
      const tuningName = document.getElementById("tuningSelect").value;
      const tuning = TUNINGS[tuningName];
      if (!tuning) return;

      const fretInputs = document.querySelectorAll(".fret-input");
      const noteOutputs = document.querySelectorAll(".string-note");

      fretInputs.forEach((input, index) => {
        const out = noteOutputs[index];
        if (!out) return;

        const raw = input.value.trim();

        // Cuerda que no suena
        if (raw === "" || raw.toLowerCase() === "x") {
          out.value = "";
          return;
        }

        const fret = parseInt(raw, 10);
        if (Number.isNaN(fret) || fret < 0 || fret > 24) {
          // Valor inválido → marcamos con raya
          out.value = "–";
          return;
        }

        const openPc = tuning.notes[index];
        const notePc = (openPc + fret) % 12;
        out.value = getNoteName(notePc); // respeta anglo/latina
      });
    }

    function clearFretInputs() {
      document.querySelectorAll(".fret-input").forEach(input => {
        input.value = "";
      });
      document.querySelectorAll(".string-note").forEach(out => {
        out.value = "";
      });
    }

    function clearMessages() {
      document.getElementById("errors").textContent = "";
      document.getElementById("result").textContent = "";
      document.getElementById("detail").textContent = "";
    }

    function calculateChord() {
      const errorsEl = document.getElementById("errors");
      const resultEl = document.getElementById("result");
      const detailEl = document.getElementById("detail");
      const fretInputs = document.querySelectorAll(".fret-input");

      errorsEl.textContent = "";
      resultEl.textContent = "";
      detailEl.textContent = "";

      const tuningName = document.getElementById("tuningSelect").value;
      const tuning = TUNINGS[tuningName];

      const notes = [];
      let hasAnyNote = false;
      let hasError = false;

      fretInputs.forEach((input, index) => {
        if (hasError) return;
        const raw = input.value.trim();

        // Cuerda que no suena
        if (raw === "" || raw.toLowerCase() === "x") {
          return;
        }

        const fret = parseInt(raw, 10);
        if (Number.isNaN(fret) || fret < 0 || fret > 24) {
          hasError = true;
          errorsEl.textContent =
            "Trastes inválidos. Usa números entre 0 y 24 o deja vacío/X para cuerdas que no suenan.";
          return;
        }

        hasAnyNote = true;
        const openPc = tuning.notes[index];
        const notePc = (openPc + fret) % 12;
        notes.push(notePc);
      });

      if (hasError) {
        resultEl.textContent = "Error en los datos";
        return;
      }

      if (!hasAnyNote) {
        resultEl.textContent = "Sin notas";
        detailEl.textContent = "Introduce al menos una cuerda con traste.";
        return;
      }

      lastChordData = null; // reseteamos

      const chordInfo = detectChord(notes);
      const uniquePcs = Array.from(new Set(notes)).sort((a, b) => a - b);
      const noteNames = uniquePcs.map(pc => getNoteName(pc)).join(" - ");

      // Si el acorde se ha reconocido, guardamos los datos
      if (chordInfo) {
        lastChordData = {
          chordInfo,
          noteNames,
          tuningName,
          tuningNotes: TUNINGS[tuningName] ? [...TUNINGS[tuningName].notes] : null,
          frets: Array.from(fretInputs).map(input => input.value.trim())
        };
      }
      
      updateStringNotes();

      if (!chordInfo) {
        resultEl.textContent = "Acorde no reconocido";
        detailEl.textContent = "Notas detectadas: " + noteNames;
      } else {
        resultEl.textContent = chordInfo.name;
        let extra;
        if (chordInfo.isPowerChord) {
          extra = "Tipo: Power chord (quinta justa) | Notas: " + noteNames;
        } else if (chordInfo.quality === "Nota aislada") {
          extra = "Nota aislada | Nota: " + noteNames;
        } else {
          extra = "Tipo: " + chordInfo.quality + " | Notas: " + noteNames;
        }
        detailEl.textContent = extra;
      }
    }

    function saveChord() {
      if (!lastChordData || !lastChordData.chordInfo) {
        alert("Primero calcula un acorde reconocido para poder guardarlo.");
        return;
      }
      // Clonamos el objeto por seguridad
      savedChords.push({ ...lastChordData });
      renderSavedChords();
    }

    function renderSavedChords() {
      const container = document.getElementById("savedChords");
      if (!container) return;

      if (savedChords.length === 0) {
        container.textContent = "No hay acordes guardados.";
        return;
      }

      container.innerHTML = savedChords.map((c, index) => {
        const fretsText = c.frets.join(" | ");
        const tuningLabel = c.tuningName +
          (c.tuningName === customTuningName ? " (personalizada)" : "");
        return `
          <div class="saved-chord">
            <div class="saved-chord-title">${index + 1}. ${c.chordInfo.name}</div>
            <div class="saved-chord-info">Afinación: ${tuningLabel}</div>
            <div class="saved-chord-notes">Notas: ${c.noteNames}</div>
            <div class="saved-chord-frets">Trastes: ${fretsText}</div>
          </div>
        `;
      }).join("");
    }

    function detectChord(notePcs) {
      const pcs = Array.from(new Set(notePcs));
      if (pcs.length === 0) return null;

      pcs.sort((a, b) => a - b);

      // Una sola nota
      if (pcs.length === 1) {
        const rootName = getNoteName(pcs[0]);
        return {
          name: rootName,
          root: rootName,
          quality: "Nota aislada"
        };
      }

      // Dos notas: intentar detectar power chord (quinta)
      if (pcs.length === 2) {
        const [a, b] = pcs;
        const intervalAB = (b - a + 12) % 12;
        const intervalBA = (a - b + 12) % 12;

        if (intervalAB === 7 || intervalBA === 7) {
          const rootPc = intervalAB === 7 ? a : b;
          const rootName = getNoteName(rootPc);
          return {
            name: rootName + "5",
            root: rootName,
            quality: "Power chord (quinta justa)",
            isPowerChord: true
          };
        }
        // Otro intervalo: lo dejamos sin identificar como acorde claro
        return null;
      }

      // Tres o más notas: probar todas como posible tónica
      let bestMatch = null;

      pcs.forEach(rootPc => {
        const intervals = pcs.map(pc => (pc - rootPc + 12) % 12).sort((a, b) => a - b);
        const intervalSet = new Set(intervals);

        CHORD_PATTERNS.forEach(pattern => {
          const isSubset = pattern.intervals.every(i => intervalSet.has(i));
          if (isSubset) {
            const score = pattern.intervals.length; // preferimos patrones más "completos"
            if (!bestMatch || score > bestMatch.score) {
              bestMatch = {
                rootPc,
                pattern,
                score
              };
            }
          }
        });
      });

      if (!bestMatch) return null;

      const rootName = getNoteName(bestMatch.rootPc);
      return {
        name: rootName + bestMatch.pattern.suffix,
        root: rootName,
        quality: bestMatch.pattern.name
      };
    }
  </script>
</body>
</html>
